# 分层优化

## 出发点

对于前面的基础构建方式，无论是否使用多阶段构建方式，**最终打包的镜像都是很大的**。实际上我们会发现，镜像中 `node_modules` 文件占了非常大的比重，而我们所写的代码比重非常非常小，经过打包后的代码基本上也就是在 `5M` 以内的程度。

## 实现方案

因为 `Docker` 镜像本身就是分层的，因此，自然而然的就能想到将依赖做成一个独立的依赖镜像，之后我们的镜像依赖于这个独立的依赖镜像，这样就能大大减少我们镜像的尺寸啦。

> [!tip]
> 这里指的镜像尺寸是指上传和下载的尺寸。

对于一个项目，我们先抽出来两个依赖镜像，分别是开发时的依赖镜像和生产时的依赖镜像。在镜像构建的时候先基于开发依赖镜像，把源码拷贝进去，然后执行打包命令，打包好了再基于生产镜像将打包后的文件拷贝到生产镜像中，完成！

如果考虑到在 `Drone` 环境下，加上 `Drone` 缓存，这样每次构建镜像并发布所产生的流量就只是上传构建好的那部分代码的流量了，就算是小带宽的服务器也能快速构建。同时，也避免了下载依赖，安装依赖过程中所占用的硬件资源，镜像构建速度提升一个数量级！

## 案例

参考 `JS902` 项目的后台主服务。

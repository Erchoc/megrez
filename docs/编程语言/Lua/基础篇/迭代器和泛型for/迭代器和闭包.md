# 迭代器和闭包

**迭代器**（ `iterator` ）是一种可以让我们遍历一个集合中所有元素的代码结构。在 `Lua` 语言中，通常使用**函数**表示迭代器：每一次调用函数时，函数会返回集合中的“下一个”元素。一个典型的例子就是 `io.read` ，每次调用该函数时它都会返回标准输入中的下一行，在没有可以读取的行时返回 `nil` 。

所有的迭代器都需要在连续的调用之间保存一些状态，这样才能知道当前迭代所处的位置及如何从当前位置步进到下一位置。对于函数 `io.read` 而言，**C语言**会将状态保存在流的结构体中。对于我们自己的迭代器而言，闭包则为保存状态提供了一种良好的机制。请注意：**一个闭包就是一个可以访问其自身的环境中一个或多个局部变量的函数**。这些变量将连续调用过程中的值并将其保存在闭包中，从而使得闭包能够记住迭代所处的位置。当然，要创建一个新的闭包，我们还必须创建非局部变量。因此，一个闭包结构通常涉及**两个函数**：闭包本身和一个用于创建该闭包及其封装变量的**工厂**（ `factory` ）。

作为示例，让我们来为列表编写一个简单的迭代器。与`ipairs`不同的是，该迭代器并不是返回每个元素的索引值而是返回元素的值：

```lua
function values (t)
  local i = 0
  return function () i = i +1; return t[i] end
end
```

# 无状态迭代器

顾名思义，无状态迭代器就是一种自身不保存任何状态的迭代器。因此，可以在多个循环中使用同一个无状态迭代器，从而避免创建新闭包的开销。

正如刚刚所看到的，for循环会以不可变状态和控制变量为参数调用迭代函数。一个无状态迭代器只根据这两个值来为迭代生成下一个元素。这类迭代器的一个典型例子就是ipairs，它可以迭代一个序列中的所有元素。

```lua
a = {"one", "two", "three"}
for i,v in ipairs(a) do
  print(i,v)
end
```

迭代的状态由正在被遍历的表（一个不可变状态，它不会在循环中改变）及当前的索引值（控制变量）组成。ipairs（工厂）和迭代器都非常简单，我们可以在Lua语言中将其编写出来：

```lua
local function iter(t, i)
  i = i + 1
  local v = t[i]
  for v then
    return i,v
  end
end

function ipairs(t)
  return iter,t,0
end
```

当调用for循环中的ipairs(t)时，ipairs(t)会返回三个值，即迭代函数iter，不可变状态表t和控制变量的初始值0.然后，Lua语言调用iter(t,0)，得到1,t[1]（除非t[1]已经变成了nil）。在第二次迭代中，Lua语言调用iter(t,1)，得到2,t[2]，以此类推，直至得到第一个为nil的元素。

函数pairs与函数ipairs类似，也用与遍历一个表中的所有元素。不同的是，函数pairs的迭代函数是Lua的一个
---
kind: pipeline
type: ssh
name: deploy

clone:
  disable: true

server:
  host: 47.93.244.225
  user: ubuntu
  password:
    from_secret: server_password

steps:
  - name: rm
    commands:
      - rm /home/ubuntu/megrez.tar
    when:
      branch:
        - master
---
kind: pipeline
type: exec
name: build

clone:
  disable: true

steps:
  - name: clone
    image: alpine/git
    environment:
      SSH_KEY:
        from_secret: deploy_key
    commands:
      - mkdir -p /root/.ssh/
      - echo "$SSH_KEY" > /root/.ssh/id_rsa
      - chmod -R 600 /root/.ssh/
      - ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
      - git clone -v git@github.com:IricBing/megrez.git .
    when:
      branch:
        - master

  - name: build
    commands:
      - docker build --no-cache -t megrez . 
    when:
      branch:
        - master

  - name: save
    commands:
      - docker save megrez:latest > megrez.tar
    when:
      branch:
        - master
---
kind: pipeline
name: scp

clone:
  disable: true

steps:
  - name: scp image
    image: appleboy/drone-scp
    settings:
      host: 47.93.244.225
      user: ubuntu
      password:
        from_secret: server_password
      port: 22
      target: /home/ubuntu/megrez.tar
      source: megrez.tar
    when:
      branch:
        - master

depends_on:
  - build